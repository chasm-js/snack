// ==UserScript==
// @name        Crack 빨간약 버튼
// @namespace   https://github.com/chasm-js
// @version     1.0
// @description 크랙의 빨간약을 들이켜보세요
// @author      chasm-js
// @match       https://crack.wrtn.ai/*
// @downloadURL  https://raw.githubusercontent.com/chasm-js/snack/refs/heads/main/redpill.user.js
// @updateURL    https://raw.githubusercontent.com/chasm-js/snack/refs/heads/main/redpill.user.js
// @grant       none
// ==/UserScript==

!function(){"use strict";const n=function(){const n=window.MutationObserver||window.WebKitMutationObserver;return function(t,e){if(!t||!n)return;const o=new n((n=>{e(n)}));return o.observe(t,{childList:!0,subtree:!0,attributes:!0}),o}}();function t(n,t){const e=(new Date).toLocaleString();n.value=`[${e}]\n${t}\n\n${n.value}`,n.scrollTop=0}function e(n,e){const o=n.value.split("\n"),r=o.findIndex((n=>n.includes("사용내역")&&n.match(/페이지 로드됨$/)));r>=0&&(o.splice(r-1,3),n.value=o.join("\n")),t(n,`사용내역 ${e} 페이지 로드됨`)}function o(n,t){const e=t-n,o=Math.floor(e/6e4),r=Math.floor(e%6e4/1e3);return`${String(o).padStart(2,"0")}분 ${String(r).padStart(2,"0")}초`}async function r(n,r){const i=function(){const n=document.cookie.split(";");for(let t of n){const[n,e]=t.trim().split("=");if("access_token"===n)return e}return null}();if(!i)return void t(n,"Error: access_token not found in cookies.");t(n,"빨간약 계산 시작...");const a=new Date;let c=1,s=[];for(;;){const d=`https://contents-api.wrtn.ai/superchat/character-super-mode/history?limit=20&type=all&page=${c}`;e(n,c);try{const e=await fetch(d,{method:"GET",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},signal:r.signal});if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);const l=await e.json();if("SUCCESS"!==l.result||!l.data||0===l.data.length){t(n,`전체 기록 호출 완료! (소요 시간: ${o(a,new Date)})`);break}s=s.concat(l.data),c++,await new Promise((n=>setTimeout(n,250)))}catch(e){if("AbortError"===e.name)return void t(n,"API 호출이 사용자에 의해 중단되었습니다.");t(n,`Error: ${e.message}`);break}}const d=s.filter((n=>n.isConsumed)).reduce(((n,t)=>n+t.quantity),0),l=s.filter((n=>!n.isConsumed)).reduce(((n,t)=>n+t.quantity),0),u={};s.filter((n=>n.isConsumed)).forEach((n=>{const t=new Date(n.date),e=`${t.getFullYear()}.${String(t.getMonth()+1).padStart(2,"0")}`;u[e]=(u[e]||0)+n.quantity}));const p={};s.filter((n=>n.isConsumed)).forEach((n=>{p[n.title]=(p[n.title]||0)+n.quantity}));const f=Object.entries(p).sort((([,n],[,t])=>t-n));let m="# 빨간약 통계\n\n";m+=`## 총 사용량\n${d}\n\n`,m+=`## 총 획득량\n${l}\n\n`,m+="## 월별 사용량\n";for(const[n,t]of Object.entries(u))m+=`- ${n}: ${t}\n`;m+="\n## title 별 사용량\n",f.forEach((([n,t],e)=>{m+=`- ${e+1}. ${n}: ${t}\n`})),n.value=`${m}\n\n${n.value}`,n.scrollTop=0}function i(){confirm("정말 빨간약을 보시겠습니까? 내역 전체를 불러오는 데에 꽤 오랜 시간이 소요될 수 있습니다. 짧은 시간 내 여러번 반복할 경우 부정 이용으로 간주될 수 있으니 충분한 여유를 두고 사용해주세요.")&&function(){const n=document.querySelector(".red-pill-modal");n&&n.remove();const t=new AbortController,e=document.createElement("div");e.className="red-pill-modal",e.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            z-index: 9999;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n        ";const o=document.createElement("div");o.style.cssText="\n            background: white;\n            padding: 20px;\n            border-radius: 5px;\n            width: 80%;\n            max-width: 600px;\n            display: flex;\n            flex-direction: column;\n            gap: 10px;\n        ";const i=document.createElement("h2");i.textContent="빨간약",i.style.cssText="\n            margin: 0;\n            font-size: 1.5em;\n            color: #ff0000;\n        ";const a=document.createElement("textarea");a.readOnly=!0,a.setAttribute("readonly","readonly"),a.style.cssText="\n            width: 100%;\n            height: 300px;\n            resize: none;\n            padding: 10px;\n            font-family: monospace;\n            border: 1px solid #ccc;\n            border-radius: 3px;\n        ";const c=document.createElement("button");c.textContent="닫기",c.style.cssText="\n            padding: 10px 20px;\n            background: #ccc;\n            color: black;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n            align-self: flex-end;\n        ",c.addEventListener("click",(()=>{t.abort(),e.remove()})),o.appendChild(i),o.appendChild(a),o.appendChild(c),e.appendChild(o),document.body.appendChild(e),r(a,t)}()}function a(){if(!/^\/superchat(\/.*)?$/.test(location.pathname))return;const n=Array.from(document.querySelectorAll('a[href="/superchat/history"]')).find((n=>n.textContent.includes("전체 내역")));if(n&&!n.parentNode.querySelector(".red-pill-button")){const t=document.createElement("button");t.className="red-pill-button",t.style.cssText="\n                margin-left: 10px;\n                padding: 5px 10px;\n                background: #ff0000;\n                color: white;\n                border: none;\n                border-radius: 3px;\n                cursor: pointer;\n            ",t.textContent="빨간약",t.addEventListener("click",i),n.parentNode.insertBefore(t,n.nextSibling)}}function c(){a();let t=location.href;new MutationObserver((()=>{const n=location.href;n!==t&&(t=n,a())})).observe(document,{subtree:!0,childList:!0}),n(document.body,(()=>{a()}))}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",c):c(),window.addEventListener("load",c)}();
